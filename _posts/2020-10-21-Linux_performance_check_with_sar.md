---
layout: post
title: 用sar发现Linux系统的瓶颈
category: 计算机
tags: [计算机, 软件]
---


----------
sar是System Activity Reporter（系统活动情况报告）的缩写。sar工具将对系统当前的状态进行取样，然后通过计算数据和比例来表达系统的当前运行状态。它的特点是可以连续对系统取样，获得大量的取样数据；取样数据和分析的结果都可以存入文件，所需的负载很小。sar是目前Linux上最为全面的系统性能分析工具之一，可以从14个大方面对系统的活动进行报告，包括文件的读写情况、系统调用的使用情况、串口、CPU效率、内存使用状况、进程活动及IPC有关的活动等，使用也是较为复杂。

sar是查看操作系统报告指标的各种工具中，最为普遍和方便的；它有两种用法；

1. 追溯过去的统计数据（默认）
2. 周期性的查看当前数据

### 追溯过去的统计数据

默认情况下，sar从最近的0点0分开始显示数据；如果想继续查看一天前的报告；可以查看保存在/var/log/sysstat/下的sa日志； 使用sar工具查看：

```
[root@matrix ~]# sar -f /var/log/sa/sa01
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/01/2020      _x86_64_        (28 CPU)

12:00:01 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
12:10:01 AM     all      1.36      0.00      0.27      0.40      0.00     97.97
12:20:01 AM     all      1.36      0.00      0.27      0.41      0.00     97.96
12:30:01 AM     all      1.38      0.00      0.27      0.41      0.00     97.95
12:40:01 AM     all      1.35      0.00      0.27      0.41      0.00     97.97
12:50:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
01:00:01 AM     all      1.34      0.00      0.26      0.42      0.00     97.98
01:10:01 AM     all      1.33      0.00      0.27      0.44      0.00     97.97
01:20:01 AM     all      1.33      0.00      0.26      0.43      0.00     97.98
01:30:01 AM     all      1.38      0.00      0.26      0.41      0.00     97.94
01:40:01 AM     all      1.34      0.00      0.27      0.42      0.00     97.97
01:50:01 AM     all      1.35      0.00      0.26      0.42      0.00     97.97
02:00:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.98
02:10:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
02:20:01 AM     all      1.33      0.00      0.27      0.43      0.00     97.97
02:30:01 AM     all      1.38      0.00      0.27      0.43      0.00     97.92
02:40:01 AM     all      1.36      0.00      0.26      0.43      0.00     97.94
02:50:01 AM     all      1.33      0.00      0.27      0.43      0.00     97.97
03:00:01 AM     all      1.44      0.00      0.27      0.43      0.00     97.86
03:10:02 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
03:20:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
03:30:01 AM     all      1.37      0.00      0.26      0.42      0.00     97.95
03:40:01 AM     all      1.38      0.00      0.26      0.42      0.00     97.93
03:50:01 AM     all      1.34      0.00      0.26      0.42      0.00     97.98
04:00:01 AM     all      1.32      0.00      0.26      0.41      0.00     98.01
04:10:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
04:20:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
04:30:01 AM     all      1.32      0.00      0.26      0.42      0.00     98.00
04:40:01 AM     all      1.40      0.00      0.26      0.42      0.00     97.93
04:50:01 AM     all      1.35      0.00      0.25      0.40      0.00     98.00
05:00:01 AM     all      1.34      0.00      0.26      0.40      0.00     98.00
05:10:01 AM     all      1.33      0.00      0.26      0.40      0.00     98.01
05:20:01 AM     all      1.33      0.00      0.26      0.41      0.00     98.00
05:30:01 AM     all      1.33      0.00      0.26      0.41      0.00     98.00
05:40:01 AM     all      1.36      0.00      0.26      0.41      0.00     97.96
05:50:01 AM     all      1.36      0.00      0.26      0.41      0.00     97.97
06:00:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
06:10:01 AM     all      1.32      0.00      0.25      0.41      0.00     98.01
06:20:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
06:30:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
06:40:01 AM     all      1.37      0.00      0.26      0.41      0.00     97.96
06:50:01 AM     all      1.38      0.00      0.26      0.42      0.00     97.94
07:00:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
07:10:01 AM     all      1.32      0.00      0.25      0.40      0.00     98.03
07:20:01 AM     all      1.32      0.00      0.26      0.41      0.00     98.02
07:30:02 AM     all      1.34      0.00      0.26      0.40      0.00     98.00
07:40:01 AM     all      1.33      0.00      0.26      0.40      0.00     98.01
07:50:01 AM     all      1.37      0.00      0.25      0.40      0.00     97.98
08:00:01 AM     all      1.35      0.00      0.24      0.39      0.00     98.01
08:10:01 AM     all      1.35      0.00      0.24      0.39      0.00     98.02
08:20:01 AM     all      1.32      0.00      0.26      0.39      0.00     98.03
08:30:01 AM     all      1.34      0.00      0.26      0.40      0.00     98.00
08:40:01 AM     all      1.36      0.00      0.25      0.41      0.00     97.99
08:50:01 AM     all      1.36      0.00      0.26      0.41      0.00     97.97
09:00:01 AM     all      1.38      0.00      0.27      0.41      0.00     97.93
09:10:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
09:20:01 AM     all      1.34      0.00      0.26      0.42      0.00     97.99

09:20:01 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
09:30:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
09:40:01 AM     all      1.34      0.00      0.26      0.42      0.00     97.98
09:50:01 AM     all      1.36      0.00      0.26      0.41      0.00     97.97
10:00:01 AM     all      1.38      0.00      0.26      0.42      0.00     97.95
10:10:01 AM     all      1.33      0.00      0.26      0.42      0.00     97.99
10:20:01 AM     all      1.34      0.00      0.26      0.41      0.00     98.00
10:30:01 AM     all      1.33      0.00      0.26      0.41      0.00     98.01
10:40:01 AM     all      1.33      0.00      0.26      0.41      0.00     98.00
10:50:01 AM     all      1.33      0.00      0.28      0.41      0.00     97.99
11:00:01 AM     all      1.36      0.00      0.27      0.41      0.00     97.96
11:10:01 AM     all      1.36      0.00      0.26      0.42      0.00     97.97
11:20:01 AM     all      1.34      0.00      0.26      0.41      0.00     97.99
11:30:01 AM     all      1.32      0.00      0.26      0.41      0.00     98.01
11:40:01 AM     all      1.33      0.00      0.26      0.41      0.00     98.00
11:50:01 AM     all      1.35      0.00      0.26      0.41      0.00     97.98
12:00:02 PM     all      1.37      0.00      0.26      0.43      0.00     97.94
12:10:01 PM     all      1.39      0.00      0.26      0.40      0.00     97.95
12:20:01 PM     all      1.32      0.00      0.25      0.39      0.00     98.03
12:30:01 PM     all      1.35      0.00      0.25      0.39      0.00     98.01
12:40:01 PM     all      1.32      0.00      0.25      0.39      0.00     98.04
12:50:01 PM     all      1.33      0.00      0.25      0.40      0.00     98.02
01:00:01 PM     all      1.37      0.00      0.25      0.40      0.00     97.98
01:10:01 PM     all      1.38      0.00      0.26      0.41      0.00     97.94
01:20:01 PM     all      1.34      0.00      0.26      0.42      0.00     97.98
01:30:01 PM     all      1.35      0.00      0.26      0.43      0.00     97.96
01:40:01 PM     all      1.33      0.00      0.27      0.42      0.00     97.98
01:50:01 PM     all      1.33      0.00      0.27      0.42      0.00     97.98
02:00:01 PM     all      1.34      0.00      0.27      0.41      0.00     97.97
02:10:01 PM     all      1.39      0.00      0.27      0.42      0.00     97.92
02:20:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.98
02:30:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.97
02:40:01 PM     all      1.33      0.00      0.26      0.41      0.00     98.00
02:50:01 PM     all      1.32      0.00      0.27      0.41      0.00     98.00
03:00:01 PM     all      1.33      0.00      0.27      0.42      0.00     97.98
03:10:01 PM     all      1.36      0.00      0.26      0.43      0.00     97.95
03:20:01 PM     all      1.39      0.00      0.26      0.42      0.00     97.93
03:30:01 PM     all      1.34      0.00      0.26      0.41      0.00     97.99
03:40:01 PM     all      1.34      0.00      0.27      0.42      0.00     97.97
03:50:01 PM     all      1.35      0.00      0.26      0.41      0.00     97.97
04:00:01 PM     all      1.33      0.00      0.26      0.42      0.00     97.99
04:10:01 PM     all      1.37      0.00      0.26      0.42      0.00     97.95
04:20:01 PM     all      1.54      0.00      0.27      0.43      0.00     97.76
04:30:01 PM     all      1.44      0.00      0.27      0.42      0.00     97.87
04:40:01 PM     all      1.34      0.00      0.26      0.41      0.00     97.99
04:50:01 PM     all      1.33      0.00      0.25      0.40      0.00     98.01
05:00:01 PM     all      1.33      0.00      0.25      0.39      0.00     98.02
05:10:01 PM     all      1.34      0.00      0.27      0.42      0.00     97.98
05:20:01 PM     all      1.39      0.00      0.26      0.42      0.00     97.93
05:30:01 PM     all      1.34      0.00      0.26      0.42      0.00     97.98
05:40:01 PM     all      1.33      0.00      0.27      0.42      0.00     97.98
05:50:01 PM     all      1.32      0.00      0.26      0.41      0.00     98.00
06:00:01 PM     all      1.33      0.00      0.26      0.42      0.00     98.00
06:10:01 PM     all      1.34      0.00      0.26      0.41      0.00     97.99
06:20:02 PM     all      1.36      0.00      0.26      0.41      0.00     97.97
06:30:01 PM     all      1.39      0.00      0.26      0.42      0.00     97.92
06:40:01 PM     all      1.33      0.00      0.27      0.43      0.00     97.98

06:40:01 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
06:50:01 PM     all      1.32      0.00      0.26      0.42      0.00     97.99
07:00:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.97
07:10:01 PM     all      1.34      0.00      0.27      0.42      0.00     97.97
07:20:01 PM     all      1.38      0.00      0.27      0.42      0.00     97.93
07:30:01 PM     all      1.40      0.00      0.26      0.42      0.00     97.91
07:40:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.97
07:50:01 PM     all      1.33      0.00      0.25      0.42      0.00     98.00
08:00:01 PM     all      1.34      0.00      0.26      0.43      0.00     97.97
08:10:01 PM     all      1.34      0.00      0.26      0.42      0.00     97.97
08:20:01 PM     all      1.33      0.00      0.26      0.41      0.00     97.99
08:30:01 PM     all      1.40      0.00      0.26      0.42      0.00     97.93
08:40:01 PM     all      1.36      0.00      0.26      0.42      0.00     97.96
08:50:01 PM     all      1.33      0.00      0.26      0.41      0.00     98.00
09:00:01 PM     all      1.33      0.00      0.25      0.41      0.00     98.01
09:10:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.97
09:20:01 PM     all      1.34      0.00      0.27      0.43      0.00     97.96
09:30:01 PM     all      1.40      0.00      0.27      0.43      0.00     97.89
09:40:01 PM     all      1.38      0.00      0.27      0.42      0.00     97.93
09:50:01 PM     all      1.33      0.00      0.27      0.42      0.00     97.98
10:00:01 PM     all      1.34      0.00      0.27      0.42      0.00     97.98
10:10:01 PM     all      1.35      0.00      0.26      0.42      0.00     97.96
10:20:01 PM     all      1.34      0.00      0.27      0.43      0.00     97.96
10:30:01 PM     all      1.36      0.00      0.27      0.43      0.00     97.94
10:40:01 PM     all      1.39      0.00      0.28      0.43      0.00     97.90
10:50:02 PM     all      1.35      0.00      0.27      0.43      0.00     97.95
11:00:01 PM     all      1.35      0.00      0.27      0.42      0.00     97.96
11:10:01 PM     all      1.34      0.00      0.28      0.47      0.00     97.91
11:20:01 PM     all      1.36      0.00      0.28      0.44      0.00     97.93
11:30:01 PM     all      1.35      0.00      0.27      0.48      0.00     97.90
11:40:01 PM     all      1.40      0.00      0.27      0.44      0.00     97.88
11:50:01 PM     all      1.38      0.00      0.28      0.45      0.00     97.89
Average:        all      1.35      0.00      0.26      0.42      0.00     97.97
```

### 查看CPU使用率

**sar -u：** 默认情况下（不带参数）显示的cpu使用率等信息就是sar -u；

```
[root@matrix ~]# sar 1 1
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/21/2020      _x86_64_        (28 CPU)

02:34:04 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:34:05 PM     all      2.26      0.00      0.43      0.79      0.00     96.52
Average:        all      2.26      0.00      0.43      0.79      0.00     96.52
[root@matrix ~]# sar -u 1 1
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/21/2020      _x86_64_        (28 CPU)

02:34:08 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:34:09 PM     all      1.65      0.00      0.47      0.57      0.00     97.31
Average:        all      1.65      0.00      0.47      0.57      0.00     97.31
```

各列指标说明：

- %user 用户模式下消耗的CPU时间的比例；
- %nice 通过nice改变了进程调度优先级的进程，在用户模式下消耗的CPU时间的比例；
- %system 系统模式下消耗的CPU时间的比例；
- %iowait CPU等待磁盘I/O导致空闲状态消耗的时间比例；
- %steal 利用Xen等操作系统虚拟化技术，等待其它虚拟CPU计算占用的时间比例；
- %idle CPU空闲时间比例。

### 查看平均负载

**sar -q：** 查看平均负载

指定-q后，就能查看运行队列中的进程数、系统上的进程大小、平均负载等；与其它命令相比，它能查看各项指标随时间变化的情况；

```
[root@matrix ~]# sar -q 1 1
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/21/2020      _x86_64_        (28 CPU)

02:37:58 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
02:37:59 PM         5      2484      0.34      0.36      0.36         0
Average:            5      2484      0.34      0.36      0.36         0
```

各列指标说明：

- runq-sz：运行队列的长度（等待运行的进程数）；
- plist-sz：进程列表中进程（processes）和线程（threads）的数量；
- ldavg-1：最后1分钟的系统平均负载 ldavg-5：过去5分钟的系统平均负载；
- ldavg-15：过去15分钟的系统平均负载。

### 查看内存使用情况

**sar -r：** 查看物理内存使用状况；

```
[root@matrix ~]# sar -r 1 1
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/21/2020      _x86_64_        (28 CPU)

02:40:10 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
02:40:11 PM  13912512  51971256     78.88      2188   9454812  67748620     74.54  43356768   5559848         0
Average:     13912512  51971256     78.88      2188   9454812  67748620     74.54  43356768   5559848         0
```

各列指标说明：

- kbmemfree：这个值和free命令中的free值基本一致,所以它不包括buffer和cache的空间；
- kbmemused：这个值和free命令中的used值基本一致,所以它包括buffer和cache的空间；
- %memused：物理内存使用率，这个值是kbmemused和内存总量(不包括swap)的一个百分比；
- kbbuffers和kbcached：这两个值就是free命令中的buffer和cache；
- kbcommit：保证当前系统所需要的内存,即为了确保不溢出而需要的内存(RAM+swap)；
- %commit：这个值是kbcommit与内存总量(包括swap)的一个百分比。

## 查看页面交换情况

**sar -W：** 查看页面交换发生状况

页面发生交换时，服务器的吞吐量会大幅下降；服务器状况不良时，如果怀疑因为内存不足而导致了页面交换的发生，可以使用这个命令来确认是否发生了大量的交换；

```
[root@matrix ~]# sar -W 1 1
Linux 5.2.4-1.el7.elrepo.x86_64 (matrix)        10/21/2020      _x86_64_        (28 CPU)

02:41:58 PM  pswpin/s pswpout/s
02:41:59 PM      0.00      0.00
Average:         0.00      0.00
```

各列指标说明：

- pswpin/s：每秒系统换入的交换页面（swap page）数量；
- pswpout/s：每秒系统换出的交换页面（swap page）数量。

### 一些经验

要判断系统瓶颈问题，有时需几个 sar 命令选项结合起来：

- 怀疑CPU存在瓶颈，可用 sar -u 和 sar -q 等来查看；
- 怀疑内存存在瓶颈，可用sar -B、sar -r 和 sar -W 等来查看；
- 怀疑I/O存在瓶颈，可用 sar -b、sar -u 和 sar -d 等来查看。

### sar参数列表

- -A 汇总所有的报告
- -a 报告文件读写使用情况
- -B 报告附加的缓存的使用情况
- -b 报告缓存的使用情况
- -c 报告系统调用的使用情况
- -d 报告磁盘的使用情况
- -g 报告串口的使用情况
- -h 报告关于buffer使用的统计数据
- -m 报告IPC消息队列和信号量的使用情况
- -n 报告命名cache的使用情况
- -p 报告调页活动的使用情况
- -q 报告运行队列和交换队列的平均长度
- -R 报告进程的活动情况
- -r 报告没有使用的内存页面和硬盘块
- -u 报告CPU的利用率
- -v 报告进程、i节点、文件和锁表状态
- -w 报告系统交换活动状况
- -y 报告TTY设备活动状况

